package com.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;

import org.springframework.stereotype.Repository;

import com.config.JDBCConfiguration;
import com.dto.Ville;

@Repository
public class VilleDAOImpl implements VilleDAO {

	private static final String SELECT_VILLE = "SELECT * FROM ville_france";
	private static final String SELECT_VILLE_CODE_POSTAL = "SELECT * FROM ville_france WHERE Code_postal=?";
	private static final String INSERT_VILLE = "INSERT INTO ville_france (Code_commune_INSEE,Nom_commune,Code_postal,"
			+ "Libelle_acheminement,Ligne_5,Latitude,Longitude) VALUES (?,?,?,?,?,?,?)";

	/**
	 * 
	 */
	public ArrayList<Ville> getAllVilles(String Param) {
		ArrayList<Ville> listeVille = new ArrayList<Ville>();

		Connection con = JDBCConfiguration.getConnection();

		ResultSet results = null;
		String requete = "SELECT * FROM ville_france ";

		try {
			Statement stmt = con.createStatement();
			results = stmt.executeQuery(requete);

			while (results.next()) {
				Ville ville = new Ville();

				ville.setCodeCommune(results.getString("Code_commune_INSEE"));
				ville.setNomCommune(results.getString("Nom_commune"));
				ville.setCodePostal(results.getString("Code_postal"));
				ville.setLibelleAcheminement(results.getString("Libelle_acheminement"));
				ville.setLigne(results.getString("Ligne_5"));

				listeVille.add(ville);
			}

		} catch (SQLException e) {
			// Traitement de l'exception
		}
		return listeVille;

	}

	public Ville getVilleByCodePostal(String codePostal) {
		// TODO Auto-generated method stub
		return null;
	}
	
	public void create(Ville ville) {
		Connection connection = null;
		PreparedStatement preparedStatement = null;
		try {
			// création de la connexion
			connection = JDBCConfiguration.getConnection();
			preparedStatement = connection.prepareStatement(initialisationRequetePreparee(INSERT_VILLE, ville.getCodeCommune(),
					ville.getNomCommune(),ville.getCodePostal(),ville.getLibelleAcheminement(),ville.getLigne(),String.valueOf(ville.getLatitude()),
					String.valueOf(ville.getLongitude())),Statement.NO_GENERATED_KEYS);
			
//			preparedStatement = connection.prepareStatement(
//					initialisationRequetePreparee(SQL_INSERT, etudiant.getIdEtudiant(),
//							etudiant.getSemestreCourant().getIdSemestre(), etudiant.getContratPro(), etudiant.getPromo()),
//					Statement.NO_GENERATED_KEYS);
			preparedStatement.executeUpdate();
					
		}
		
	}
	
	
	/**
	 * Initialise une requête préparée.
	 * 
	 * @param sql la requête SQL.
	 * @param la liste d'objets à insérer dans la requête.
	 * @return La requête SQL complété des paramètres
	 * @throws SQLException
	 */
	protected static String initialisationRequetePreparee(String sql, String[] parametres) {
		String[] listeSQL = (sql+" ").split("\\?");
		StringBuilder newSQL = new StringBuilder(listeSQL[0]);
		for(int i = 0; i<parametres.length; i++) {
			newSQL.append("\"" + parametres[i] + "\"" + listeSQL[i+1]);
		}
		return newSQL.toString().replaceAll("\"null\"", "null");
	}

}